<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ElectroDynamics — Ion Transport Simulation</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Sora:wght@400;600;700&display=swap');

/* ═══════════════════════════════════════════
   TOKENS
═══════════════════════════════════════════ */
:root{
  --bg:#070b14; --surf:#0d1526; --surf2:#111d35;
  --border:#1e3a5f; --accent:#00d4ff; --purple:#7c3aed;
  --green:#00ff88; --orange:#ff8c00; --red:#ff3366; --yellow:#ffe066;
  --text:#e2e8f0; --muted:#6b7a99;
}

/* ═══════════════════════════════════════════
   RESET & BASE
═══════════════════════════════════════════ */
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{
  background:var(--bg); color:var(--text);
  font-family:'Sora',sans-serif;
  min-height:100vh;
  overflow-x:hidden;
  -webkit-tap-highlight-color:transparent;
}
::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}

/* ═══════════════════════════════════════════
   HEADER
═══════════════════════════════════════════ */
.site-header{
  position:sticky; top:0; z-index:100;
  background:rgba(7,11,20,.95);
  border-bottom:1px solid var(--border);
  backdrop-filter:blur(12px);
  -webkit-backdrop-filter:blur(12px);
}
.header-inner{
  max-width:1400px; margin:0 auto;
  display:flex; align-items:center; justify-content:space-between;
  padding:0 20px; height:56px; gap:12px;
}
.logo{display:flex;align-items:center;gap:10px;flex-shrink:0;}
.logo-icon{
  width:32px;height:32px;
  background:linear-gradient(135deg,var(--accent),var(--purple));
  border-radius:8px;display:flex;align-items:center;justify-content:center;
  font-size:16px;flex-shrink:0;
}
.logo-title{font-size:15px;font-weight:700;letter-spacing:-.3px;}
.logo-title span{color:var(--accent);}
.logo-sub{font-size:9px;color:var(--muted);font-family:'JetBrains Mono',monospace;}
.hdr-btns{display:flex;gap:6px;align-items:center;flex-wrap:wrap;}

/* ═══════════════════════════════════════════
   PAGE WRAPPER
═══════════════════════════════════════════ */
.page{
  max-width:1400px; margin:0 auto;
  padding:16px 16px 32px;
  display:grid;
  grid-template-columns:260px 1fr 240px;
  grid-template-rows:auto auto auto;
  gap:12px;
}

/* ═══════════════════════════════════════════
   STEP PILLS (top of page on mobile)
═══════════════════════════════════════════ */
.step-pills{
  grid-column:1/-1;
  display:none; /* shown on mobile */
  gap:6px;
  overflow-x:auto;
  padding-bottom:4px;
}
.step-pill{
  flex-shrink:0;
  background:var(--surf2); border:1px solid var(--border);
  border-radius:20px; padding:6px 14px;
  font-size:11px; font-weight:600; color:var(--muted);
  cursor:pointer; transition:all .18s; white-space:nowrap;
  font-family:'Sora',sans-serif;
}
.step-pill:hover{border-color:var(--accent);color:var(--text);}
.step-pill.active{
  background:rgba(0,212,255,.12);
  border-color:var(--accent); color:var(--accent);
  box-shadow:0 0 12px rgba(0,212,255,.15);
}

/* ═══════════════════════════════════════════
   LEFT PANEL
═══════════════════════════════════════════ */
.left-panel{
  display:flex; flex-direction:column; gap:8px;
}

.panel-label{
  font-size:9px; font-weight:700; letter-spacing:2px;
  color:var(--muted); text-transform:uppercase; padding:0 2px;
  margin-bottom:2px;
}

.step-btn{
  background:var(--surf2); border:1px solid var(--border);
  border-radius:10px; padding:11px 13px;
  cursor:pointer; transition:all .18s;
  text-align:left; width:100%; color:var(--text);
  font-family:'Sora',sans-serif;
}
.step-btn:hover{border-color:var(--accent);background:rgba(0,212,255,.05);}
.step-btn.active{
  border-color:var(--accent);background:rgba(0,212,255,.1);
  box-shadow:0 0 18px rgba(0,212,255,.1);
}
.step-num{
  font-size:9px;color:var(--accent);
  font-family:'JetBrains Mono',monospace;
  font-weight:600;letter-spacing:1px;
  text-transform:uppercase;margin-bottom:3px;
}
.step-name{font-size:12px;font-weight:600;margin-bottom:3px;}
.step-desc{font-size:10px;color:var(--muted);line-height:1.4;}

.theory-box{
  background:rgba(0,212,255,.04);
  border:1px solid rgba(0,212,255,.18);
  border-radius:10px; padding:13px;
}
.theory-title{font-size:11px;color:var(--accent);font-weight:600;margin-bottom:6px;}
.theory-text{font-size:11px;color:#94a3b8;line-height:1.6;}
.formula{
  font-family:'JetBrains Mono',monospace;
  background:rgba(0,0,0,.3); border:1px solid var(--border);
  border-radius:6px; padding:7px 10px;
  font-size:10px; color:var(--yellow);
  margin-top:8px; text-align:center;
}

/* ═══════════════════════════════════════════
   CANVAS SECTION
═══════════════════════════════════════════ */
.sim-section{
  display:flex; flex-direction:column; gap:8px;
}

.canvas-card{
  background:var(--bg);
  border:1px solid var(--border);
  border-radius:12px;
  overflow:hidden;
  position:relative;
}

#simCanvas{
  display:block; width:100%;
  touch-action:none;
  cursor:grab;
}
#simCanvas:active{cursor:grabbing;}

.canvas-badges{
  position:absolute; top:10px; left:10px;
  display:flex; flex-direction:column; gap:5px;
  pointer-events:none;
}
.badge{
  background:rgba(7,11,20,.92); border:1px solid var(--border);
  border-radius:5px; padding:4px 9px;
  font-size:10px; font-family:'JetBrains Mono',monospace;
  color:var(--accent); backdrop-filter:blur(8px); white-space:nowrap;
}
.badge.warn{color:var(--orange);border-color:rgba(255,140,0,.35);}
.badge.ok  {color:var(--green); border-color:rgba(0,255,136,.35);}

.step-dots{
  position:absolute; bottom:10px; left:50%; transform:translateX(-50%);
  display:flex; gap:7px; pointer-events:none;
}
.dot{width:7px;height:7px;border-radius:50%;background:var(--border);transition:all .3s;}
.dot.active{background:var(--accent);box-shadow:0 0 6px var(--accent);}

/* Mobile sliders strip — inside sim-section, below canvas */
.mob-sliders{
  display:none;
  background:var(--surf);
  border:1px solid var(--border);
  border-radius:10px;
  padding:12px 14px;
  flex-direction:column; gap:10px;
}

/* ═══════════════════════════════════════════
   RIGHT PANEL
═══════════════════════════════════════════ */
.right-panel{
  display:flex; flex-direction:column; gap:12px;
}

.ctrl-group{display:flex;flex-direction:column;gap:8px;}
.ctrl-label{
  font-size:10px;color:var(--muted);font-weight:600;
  letter-spacing:1px;text-transform:uppercase;
  display:flex;justify-content:space-between;align-items:center;
}
.ctrl-val{
  font-family:'JetBrains Mono',monospace;
  color:var(--accent);font-size:11px;font-weight:600;
}

input[type=range]{
  width:100%; -webkit-appearance:none;
  height:4px; border-radius:2px;
  background:var(--surf2); outline:none; cursor:pointer;
}
input[type=range]::-webkit-slider-thumb{
  -webkit-appearance:none;
  width:16px;height:16px; border-radius:50%;
  background:var(--accent); box-shadow:0 0 7px var(--accent);
  cursor:pointer; border:2px solid var(--bg);
}
input[type=range]::-moz-range-thumb{
  width:16px;height:16px;border-radius:50%;
  background:var(--accent);border:2px solid var(--bg);cursor:pointer;
}

.toggle-row{
  display:flex;align-items:center;justify-content:space-between;
  padding:9px 11px; background:var(--surf2);
  border:1px solid var(--border); border-radius:8px;
  cursor:pointer; transition:all .18s; user-select:none;
}
.toggle-row:hover{border-color:var(--accent);}
.toggle-row.active{border-color:var(--green);background:rgba(0,255,136,.05);}
.toggle-label{font-size:11px;font-weight:500;}
.tsw{
  width:30px;height:17px;background:var(--border);
  border-radius:9px;position:relative;transition:all .18s;flex-shrink:0;
}
.tsw::after{
  content:'';position:absolute;width:13px;height:13px;
  border-radius:50%;background:var(--muted);
  top:2px;left:2px;transition:all .18s;
}
.toggle-row.active .tsw{background:rgba(0,255,136,.3);}
.toggle-row.active .tsw::after{left:15px;background:var(--green);box-shadow:0 0 5px var(--green);}

.btn{
  border:1px solid var(--border); border-radius:8px;
  padding:8px 14px; font-family:'Sora',sans-serif;
  font-size:12px;font-weight:600;cursor:pointer;
  transition:all .18s; white-space:nowrap;
  background:var(--surf2);color:var(--muted);
}
.btn:active{transform:scale(.96);}
.btn:hover{border-color:var(--muted);color:var(--text);}
.btn-p{background:rgba(0,212,255,.1);border-color:var(--accent);color:var(--accent);}
.btn-p:hover{background:rgba(0,212,255,.2);}
.btn-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;}

.divider{height:1px;background:var(--border);}

.legend{display:flex;flex-direction:column;gap:6px;}
.leg-item{display:flex;align-items:center;gap:8px;font-size:10px;color:var(--muted);}
.leg-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0;}
.leg-line{width:18px;height:2px;flex-shrink:0;}

.chart-card{background:var(--surf2);border:1px solid var(--border);border-radius:8px;padding:10px;}
.chart-title{font-size:9px;color:var(--muted);font-weight:600;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;}
.chart-card canvas{display:block;width:100%;}

.stat{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted);}
.stat span{color:var(--accent);}

/* ═══════════════════════════════════════════
   FOOTER
═══════════════════════════════════════════ */
.site-footer{
  border-top:1px solid var(--border);
  padding:12px 20px;
  display:flex;align-items:center;justify-content:space-between;
  font-size:10px;color:var(--muted);
  font-family:'JetBrains Mono',monospace;
  flex-wrap:wrap;gap:8px;
  max-width:1400px;margin:0 auto;
}
.site-footer span{color:var(--accent);}

/* ═══════════════════════════════════════════
   TABLET  ≤1100px — collapse right panel below canvas
═══════════════════════════════════════════ */
@media(max-width:1100px){
  .page{
    grid-template-columns:220px 1fr;
    grid-template-rows:auto auto auto;
  }
  .right-panel{
    grid-column:1/-1;
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
    gap:12px;
    align-items:start;
  }
  /* right panel items that should span full width */
  .right-panel .divider,
  .right-panel .panel-label{grid-column:1/-1;}
  .right-panel .btn-row{grid-column:1/-1;}
  .right-panel .chart-card{grid-column:1/-1;}
}

/* ═══════════════════════════════════════════
   MOBILE  ≤700px — single column stacked
═══════════════════════════════════════════ */
@media(max-width:700px){
  .page{
    grid-template-columns:1fr;
    padding:10px 10px 24px;
    gap:10px;
  }

  /* Show step pills, hide verbose left panel */
  .step-pills{display:flex;}
  .left-panel{display:none;}

  /* Show inline mobile sliders */
  .mob-sliders{display:flex;}

  /* Right panel becomes full-width card grid */
  .right-panel{
    grid-column:1;
    grid-template-columns:1fr 1fr;
  }

  /* Reflow header */
  .header-inner{padding:0 12px;height:52px;}
  .logo-sub{display:none;}
  .hdr-btns .btn{padding:7px 10px;font-size:11px;}

  /* Theory box shown below step pills */
  .mob-theory{display:flex;}
}

/* ═══════════════════════════════════════════
   MOBILE THEORY BOX (hidden on desktop)
═══════════════════════════════════════════ */
.mob-theory{
  display:none;
  grid-column:1/-1;
  background:rgba(0,212,255,.04);
  border:1px solid rgba(0,212,255,.18);
  border-radius:10px; padding:13px;
  flex-direction:column; gap:6px;
}
.mob-theory .theory-title{font-size:11px;color:var(--accent);font-weight:600;}
.mob-theory .theory-text{font-size:11px;color:#94a3b8;line-height:1.6;}
.mob-theory .formula{
  font-family:'JetBrains Mono',monospace;
  background:rgba(0,0,0,.3);border:1px solid var(--border);
  border-radius:6px;padding:7px;font-size:10px;
  color:var(--yellow);text-align:center;
}

/* Very small screens */
@media(max-width:400px){
  .right-panel{grid-template-columns:1fr;}
  .hdr-btns .btn-label{display:none;}
}
</style>
</head>
<body>

<!-- ═══════════════════════════════════════
     HEADER
═══════════════════════════════════════ -->
<header class="site-header">
  <div class="header-inner">
    <div class="logo">
      <div class="logo-icon">⚡</div>
      <div>
        <div class="logo-title">Electro<span>Dynamics</span></div>
        <div class="logo-sub">Physical Chemistry · Ion Transport</div>
      </div>
    </div>
    <div class="hdr-btns">
      <button class="btn" id="btnPause">⏸ <span class="btn-label">Pause</span></button>
      <button class="btn" id="btnReset">↺ <span class="btn-label">Reset</span></button>
      <button class="btn btn-p" id="btnNext">Next →</button>
    </div>
  </div>
</header>

<!-- ═══════════════════════════════════════
     MAIN PAGE
═══════════════════════════════════════ -->
<main class="page">

  <!-- Mobile step pills (hidden on desktop) -->
  <div class="step-pills">
    <button class="step-pill active" onclick="setStep(0)">01 Hydration</button>
    <button class="step-pill"       onclick="setStep(1)">02 Atmosphere</button>
    <button class="step-pill"       onclick="setStep(2)">03 Relaxation</button>
    <button class="step-pill"       onclick="setStep(3)">04 Electrophoretic</button>
  </div>

  <!-- Mobile theory box (hidden on desktop) -->
  <div class="mob-theory" id="mobTheory">
    <div class="theory-title" id="mobTheoryTitle">Ion Solvation</div>
    <div class="theory-text"  id="mobTheoryText">Water dipoles orient around the ion via ion-dipole forces. O (δ−) faces cations. Inner shell is tightly bound; outer shell less ordered.</div>
    <div class="formula" id="mobTheoryFormula">ΔG_hyd = −z²e²N_A / (8πε₀r)(1−1/ε_r)</div>
  </div>

  <!-- ── LEFT PANEL ── -->
  <aside class="left-panel">
    <div class="panel-label">Learning Steps</div>

    <button class="step-btn active" onclick="setStep(0)">
      <div class="step-num">Step 01</div>
      <div class="step-name">Ion Solvation</div>
      <div class="step-desc">Hydration shells &amp; dipole orientation</div>
    </button>
    <button class="step-btn" onclick="setStep(1)">
      <div class="step-num">Step 02</div>
      <div class="step-name">Ionic Atmosphere</div>
      <div class="step-desc">Debye–Hückel counter-ion cloud</div>
    </button>
    <button class="step-btn" onclick="setStep(2)">
      <div class="step-num">Step 03</div>
      <div class="step-name">Relaxation Effect</div>
      <div class="step-desc">Elliptical lag under E-field</div>
    </button>
    <button class="step-btn" onclick="setStep(3)">
      <div class="step-num">Step 04</div>
      <div class="step-name">Electrophoretic</div>
      <div class="step-desc">Solvent backflow &amp; drag</div>
    </button>

    <div class="divider"></div>

    <div class="theory-box">
      <div class="theory-title" id="theoryTitle">Ion Solvation</div>
      <div class="theory-text"  id="theoryText">Water dipoles orient around the ion via ion-dipole forces. O (δ−) faces cations. Inner shell is tightly bound; outer shell less ordered.</div>
      <div class="formula" id="theoryFormula">ΔG_hyd = −z²e²N_A / (8πε₀r)(1−1/ε_r)</div>
    </div>
  </aside>

  <!-- ── SIM SECTION ── -->
  <section class="sim-section">

    <div class="canvas-card">
      <canvas id="simCanvas"></canvas>
      <div class="canvas-badges">
        <div class="badge"      id="badgeStep">STEP 1: HYDRATION</div>
        <div class="badge warn" id="badgeField"  style="display:none">⚡ E-FIELD</div>
        <div class="badge ok"   id="badgeInfDil" style="display:none">∞ INF. DILUTION</div>
      </div>
      <div class="step-dots">
        <div class="dot active" id="dot0"></div>
        <div class="dot" id="dot1"></div>
        <div class="dot" id="dot2"></div>
        <div class="dot" id="dot3"></div>
      </div>
    </div>

    <!-- Mobile-only inline sliders -->
    <div class="mob-sliders" id="mobSliders">
      <div class="ctrl-group">
        <div class="ctrl-label">Electric Field <span class="ctrl-val" id="mEfieldVal">0.0</span></div>
        <input type="range" id="mSliderEfield" min="0" max="100" value="0" step="1">
      </div>
      <div class="ctrl-group">
        <div class="ctrl-label">Concentration <span class="ctrl-val" id="mConcVal">0.10 M</span></div>
        <input type="range" id="mSliderConc" min="1" max="100" value="10" step="1">
      </div>
      <div class="ctrl-group">
        <div class="ctrl-label">Slow Motion <span class="ctrl-val" id="mSlowVal">1.0×</span></div>
        <input type="range" id="mSliderSlow" min="1" max="10" value="1" step="1">
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <div class="toggle-row" id="mToggleInfDil" onclick="toggleInfDil()" style="flex:1;min-width:140px;">
          <span class="toggle-label">Infinite Dilution</span><div class="tsw"></div>
        </div>
        <div class="toggle-row active" id="mToggleDipoles" onclick="toggleDipoles()" style="flex:1;min-width:120px;">
          <span class="toggle-label">Show Dipoles</span><div class="tsw"></div>
        </div>
      </div>
    </div>

  </section>

  <!-- ── RIGHT PANEL ── -->
  <aside class="right-panel">

    <div class="panel-label">Controls</div>

    <div class="ctrl-group">
      <div class="ctrl-label">Electric Field <span class="ctrl-val" id="efieldVal">0.0</span></div>
      <input type="range" id="sliderEfield" min="0" max="100" value="0" step="1">
    </div>
    <div class="ctrl-group">
      <div class="ctrl-label">Slow Motion <span class="ctrl-val" id="slowVal">1.0×</span></div>
      <input type="range" id="sliderSlow" min="1" max="10" value="1" step="1">
    </div>
    <div class="ctrl-group">
      <div class="ctrl-label">Concentration <span class="ctrl-val" id="concVal">0.10 M</span></div>
      <input type="range" id="sliderConc" min="1" max="100" value="10" step="1">
    </div>

    <div class="divider"></div>

    <div class="toggle-row" id="toggleInfDil" onclick="toggleInfDil()">
      <span class="toggle-label">Infinite Dilution</span><div class="tsw"></div>
    </div>
    <div class="toggle-row active" id="toggleLabels" onclick="toggleLabels()">
      <span class="toggle-label">Show Labels</span><div class="tsw"></div>
    </div>
    <div class="toggle-row active" id="toggleDipoles" onclick="toggleDipoles()">
      <span class="toggle-label">Show Dipoles</span><div class="tsw"></div>
    </div>

    <div class="btn-row">
      <button class="btn" onclick="setStep(Math.max(0,currentStep-1))">← Prev</button>
      <button class="btn btn-p" onclick="setStep(Math.min(3,currentStep+1))">Next →</button>
    </div>

    <div class="divider"></div>

    <div class="panel-label">Legend</div>
    <div class="legend">
      <div class="leg-item"><div class="leg-dot" style="background:#00d4ff;box-shadow:0 0 5px #00d4ff"></div>Na⁺ central ion</div>
      <div class="leg-item"><div class="leg-dot" style="background:#ff3366;box-shadow:0 0 5px #ff3366"></div>Counter-ion (−)</div>
      <div class="leg-item"><div class="leg-dot" style="background:#00ff88;box-shadow:0 0 5px #00ff88"></div>Co-ion (+)</div>
      <div class="leg-item"><div class="leg-dot" style="background:rgba(180,160,255,.7)"></div>Water (H₂O)</div>
      <div class="leg-item"><div class="leg-line" style="background:linear-gradient(90deg,transparent,#ff8c00)"></div>Backflow</div>
    </div>

    <div class="divider"></div>

    <div class="chart-card">
      <div class="chart-title">Λ vs √c — Onsager</div>
      <canvas id="chartCanvas" height="80"></canvas>
    </div>

    <div class="panel-label">State</div>
    <div class="stat">Velocity: <span id="statVel">0.0</span></div>
    <div class="stat">Atm. lag: <span id="statLag">0°</span></div>
    <div class="stat">Λ/Λ₀: <span id="condRatio">1.00</span></div>

  </aside>

</main>

<!-- ═══════════════════════════════════════
     FOOTER
═══════════════════════════════════════ -->
<footer>
  <div class="site-footer">
    <div>Physical Chemistry Simulation · Debye–Hückel Theory · Onsager Equation</div>
    <div>FPS <span id="fpsStat">60</span> &nbsp;·&nbsp; Step <span id="stepStat">1</span>/4 &nbsp;·&nbsp; Λ/Λ₀ <span id="condRatioF">1.00</span></div>
  </div>
</footer>


<!-- ═══════════════════════════════════════
     SIMULATION JAVASCRIPT
═══════════════════════════════════════ -->
<script>
/* ════════════════════════════════════════════════════
   STATE
════════════════════════════════════════════════════ */
let currentStep = 0;
let paused      = false;
let infDil      = false;
let showLabels  = true;
let showDipoles = true;
let efield      = 0;
let slowFactor  = 1;
let concentration = 0.10;
let animTime    = 0;
let lastTime    = 0;
let fps = 60, frameCount = 0, lastFpsTime = 0;
let atmLag = 0;
let counterIons = [], coIons = [], backflowPtcl = [];

const ion = { x:0, y:0, vx:0, vy:0, r:18, dragging:false };

const canvas   = document.getElementById('simCanvas');
const ctx      = canvas.getContext('2d');
const chartCv  = document.getElementById('chartCanvas');
const chartCtx = chartCv.getContext('2d');

/* ════════════════════════════════════════════════════
   STEP DATA
════════════════════════════════════════════════════ */
const STEPS = [
  {
    badge:'STEP 1: HYDRATION', title:'Ion Solvation',
    text:'Water dipoles orient around the ion via ion-dipole forces. O (δ−) faces cations. Inner shell is tightly bound; outer shell less ordered.',
    formula:'ΔG_hyd = −z²e²N_A / (8πε₀r)(1−1/ε_r)'
  },
  {
    badge:'STEP 2: IONIC ATMOSPHERE', title:'Ionic Atmosphere',
    text:'Each ion is surrounded by a spherical cloud of counter-ions. At equilibrium it is perfectly circular. The cloud thickens at lower concentration.',
    formula:''
  },
  {
    badge:'STEP 3: RELAXATION', title:'Relaxation Effect',
    text:'The ion moves faster than its atmosphere can reorganize. The cloud lags, becoming an ellipse shifted opposite to motion. This retards the ion.',
    formula:'δμ = −z²e² / (6πηκ⁻¹)'
  },
  {
    badge:'STEP 4: ELECTROPHORETIC', title:'Electrophoretic Effect',
    text:'Counter-ions migrate opposite to the central ion, dragging solvent with them. This backflow adds a second retarding force.',
    formula:'Δu = −zeE / (6πηκ⁻¹)'
  }
];

/* ════════════════════════════════════════════════════
   CANVAS SIZING — fills its card fluidly
════════════════════════════════════════════════════ */
const CANVAS_ASPECT = 16/9; // target aspect ratio

function resizeCanvas() {
  const card = canvas.parentElement;
  const w = card.clientWidth;
  // Clamp height: min 240px, max 520px
  const h = Math.min(520, Math.max(240, Math.round(w / CANVAS_ASPECT)));
  canvas.width  = w;
  canvas.height = h;
  // Update chart canvas width too
  const cc = chartCv.parentElement;
  if(cc) chartCv.width = cc.clientWidth - 20;
  // Re-center ion
  ion.x = w / 2;
  ion.y = h / 2;
  initParticles();
}

/* ════════════════════════════════════════════════════
   setStep
════════════════════════════════════════════════════ */
function setStep(n) {
  currentStep = n;

  // Desktop step buttons
  document.querySelectorAll('.step-btn').forEach((b,i) => b.classList.toggle('active', i===n));
  // Mobile pills
  document.querySelectorAll('.step-pill').forEach((b,i) => b.classList.toggle('active', i===n));
  // Dots
  for(let i=0;i<4;i++){
    const d = document.getElementById('dot'+i); if(d) d.classList.toggle('active', i===n);
  }

  // Sync theory — desktop
  const s = STEPS[n];
  document.getElementById('badgeStep').textContent   = s.badge;
  document.getElementById('theoryTitle').textContent = s.title;
  document.getElementById('theoryText').textContent  = s.text;
  const fEl = document.getElementById('theoryFormula');
  fEl.textContent   = s.formula;
  fEl.style.display = s.formula ? 'block' : 'none';

  // Sync theory — mobile
  document.getElementById('mobTheoryTitle').textContent = s.title;
  document.getElementById('mobTheoryText').textContent  = s.text;
  const mfEl = document.getElementById('mobTheoryFormula');
  mfEl.textContent   = s.formula;
  mfEl.style.display = s.formula ? 'block' : 'none';

  document.getElementById('stepStat').textContent = n+1;
  atmLag = 0;
  initParticles();
}

/* ════════════════════════════════════════════════════
   PHYSICS HELPERS
════════════════════════════════════════════════════ */
function debyeR() {
  if(infDil) return 240;
  return Math.min(200, Math.max(50, 90/Math.sqrt(concentration)));
}

function initParticles() {
  if(!canvas.width) return;
  const dr = debyeR(), cx = ion.x, cy = ion.y;

  counterIons = [];
  const nC = Math.max(5, Math.min(14, Math.round(concentration*70)));
  for(let i=0;i<nC;i++){
    const a = Math.random()*Math.PI*2;
    const r = dr*(.5 + Math.random()*.75);
    counterIons.push({x:cx+Math.cos(a)*r, y:cy+Math.sin(a)*r, baseR:r*(.9+Math.random()*.2), phase:Math.random()*Math.PI*2, r:8});
  }

  coIons = [];
  const nCo = Math.max(2, Math.min(7, Math.round(concentration*35)));
  for(let i=0;i<nCo;i++){
    const a = Math.random()*Math.PI*2;
    const r = dr*(1 + Math.random()*.8);
    coIons.push({x:cx+Math.cos(a)*r, y:cy+Math.sin(a)*r, baseR:r, phase:Math.random()*Math.PI*2, r:8});
  }

  backflowPtcl = [];
  for(let i=0;i<18;i++) backflowPtcl.push(newBfp());
}

function newBfp() {
  const dr = debyeR(), a = Math.random()*Math.PI*2;
  const r  = dr*(.4 + Math.random()*1.1);
  return { x:ion.x+Math.cos(a)*r, y:ion.y+Math.sin(a)*r, alpha:0, life:Math.random(), maxLife:1+Math.random() };
}

/* ════════════════════════════════════════════════════
   UPDATE
════════════════════════════════════════════════════ */
function update(dt) {
  if(paused) return;
  const sdt = dt / slowFactor;
  animTime += sdt;
  const ef = efield / 100;

  // Ion drift
  if(!ion.dragging) {
    const relax = infDil ? 0 : ef*.25*Math.min(1, concentration*5);
    const ep    = infDil ? 0 : ef*.15*Math.min(1, concentration*4);
    ion.vx = ion.vx*.93 + (ef*1.2 - relax - ep)*.8;
    ion.vy = ion.vy*.93;
    ion.x += ion.vx*sdt*60;
    ion.y += ion.vy*sdt*60;
    if(ion.x > canvas.width+50)  { ion.x = -50;              ion.vx=0; }
    if(ion.x < -50)              { ion.x = canvas.width+50;  ion.vx=0; }
    ion.y = Math.max(40, Math.min(canvas.height-40, ion.y));
  }

  // Atmosphere lag → ellipse
  const lagTarget = (currentStep>=2 && !infDil) ? ef*.8*Math.min(1, concentration*5) : 0;
  atmLag += (lagTarget - atmLag)*.03;

  const dr = debyeR();

  counterIons.forEach((ci,i) => {
    const ba = (i/counterIons.length)*Math.PI*2 + ci.phase + animTime*.18;
    const lx = ion.x + Math.cos(ba - atmLag*.5)*(ci.baseR*(dr/120)+10);
    const ly = ion.y + Math.sin(ba - atmLag*.5)*(ci.baseR*(dr/120)+10)*.85;
    ci.x += (lx-ci.x)*.04; ci.y += (ly-ci.y)*.04;
    if(currentStep>=3 && !infDil && efield>0) ci.x -= ef*.3*sdt*60;
  });

  coIons.forEach((ci,i) => {
    const ba = (i/coIons.length)*Math.PI*2 + ci.phase + animTime*.13;
    const lx = ion.x + Math.cos(ba)*(ci.baseR*(dr/120)+20);
    const ly = ion.y + Math.sin(ba)*(ci.baseR*(dr/120)+20)*.85;
    ci.x += (lx-ci.x)*.03; ci.y += (ly-ci.y)*.03;
  });

  if(currentStep>=3 && efield>0 && !infDil) {
    backflowPtcl.forEach(p => {
      p.life += sdt;
      p.alpha = Math.sin(p.life/p.maxLife*Math.PI)*.7;
      p.x -= ef*.5*sdt*60;
      if(p.life > p.maxLife) {
        Object.assign(p, newBfp());
        p.x = ion.x + dr*(.3+Math.random()*.8)*(Math.random()>.5?1:-1);
        p.y = ion.y + (Math.random()-.5)*dr*1.4;
      }
    });
  }

  // Stats
  const r1 = infDil?0:.22*Math.sqrt(concentration);
  const r2 = infDil?0:.30*Math.sqrt(concentration);
  const ratio = Math.max(.2, 1-r1-r2).toFixed(2);
  document.getElementById('statVel').textContent    = (Math.abs(ion.vx*60)).toFixed(1);
  document.getElementById('statLag').textContent    = (atmLag*57.3).toFixed(1)+'°';
  document.getElementById('condRatio').textContent  = ratio;
  document.getElementById('condRatioF').textContent = ratio;
}

/* ════════════════════════════════════════════════════
   DRAW
════════════════════════════════════════════════════ */
function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawGrid();
  if(currentStep>=1 && !infDil) drawAtmosphere();
  if(currentStep>=3 && efield>0 && !infDil) drawBackflow();
  if(showDipoles) drawHydration();
  if(currentStep>=1 && !infDil) { drawCounterIons(); drawCoIons(); }
  drawIon();
  drawEfield();
  if(showLabels) drawLabels();
}

function drawGrid() {
  ctx.save();
  ctx.strokeStyle='rgba(30,58,95,.35)'; ctx.lineWidth=.5;
  for(let x=0;x<canvas.width;x+=40){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,canvas.height);ctx.stroke();}
  for(let y=0;y<canvas.height;y+=40){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(canvas.width,y);ctx.stroke();}
  ctx.restore();
}

function drawAtmosphere() {
  const cx=ion.x, cy=ion.y, dr=debyeR();
  const lag = Math.min(1, Math.abs(atmLag));
  const rx = dr*(1+lag*.45), ry = dr*(1-lag*.18);
  const ox = -atmLag*dr*.22;
  ctx.save();
  ctx.translate(cx+ox, cy);
  const g = ctx.createRadialGradient(0,0,dr*.2,0,0,Math.max(rx,ry));
  g.addColorStop(0,'rgba(255,51,102,0)');
  g.addColorStop(.45,'rgba(255,51,102,.08)');
  g.addColorStop(.75,'rgba(255,51,102,.05)');
  g.addColorStop(1,'rgba(255,51,102,0)');
  ctx.scale(rx/dr, ry/dr);
  ctx.fillStyle=g; ctx.beginPath(); ctx.arc(0,0,dr,0,Math.PI*2); ctx.fill();
  ctx.strokeStyle=`rgba(255,51,102,${.25+.1*Math.sin(animTime*2)})`;
  ctx.setLineDash([5,4]); ctx.lineWidth=1.5/Math.max(rx/dr,ry/dr);
  ctx.beginPath(); ctx.arc(0,0,dr,0,Math.PI*2); ctx.stroke();
  ctx.setLineDash([]); ctx.restore();
}

function drawHydration() {
  const cx=ion.x, cy=ion.y, pr=ion.r+22, sr=ion.r+56;
  for(let i=0;i<8;i++){const a=(i/8)*Math.PI*2+animTime*.04; drawDipole(cx+Math.cos(a)*pr, cy+Math.sin(a)*pr, a+Math.PI, 1);}
  for(let i=0;i<13;i++){const a=(i/13)*Math.PI*2+animTime*.018; drawDipole(cx+Math.cos(a)*sr, cy+Math.sin(a)*sr, a+Math.PI, .45);}
  ctx.save();
  ctx.strokeStyle='rgba(140,120,255,.11)'; ctx.setLineDash([3,5]); ctx.lineWidth=1;
  ctx.beginPath(); ctx.arc(cx,cy,pr,0,Math.PI*2); ctx.stroke();
  ctx.strokeStyle='rgba(140,120,255,.06)';
  ctx.beginPath(); ctx.arc(cx,cy,sr,0,Math.PI*2); ctx.stroke();
  ctx.setLineDash([]); ctx.restore();
}

function drawDipole(x,y,angle,alpha) {
  ctx.save(); ctx.translate(x,y); ctx.rotate(angle); ctx.globalAlpha=alpha*.72;
  const og=ctx.createRadialGradient(-3,0,0,-3,0,6);
  og.addColorStop(0,'#ff6060'); og.addColorStop(1,'rgba(255,60,60,0)');
  ctx.fillStyle=og; ctx.beginPath(); ctx.arc(-3,0,6,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='rgba(200,200,255,.8)';
  ctx.beginPath(); ctx.arc(4.5,-4.5,3.5,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(4.5,4.5,3.5,0,Math.PI*2); ctx.fill();
  ctx.strokeStyle='rgba(200,200,255,.25)'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(-1,0); ctx.lineTo(3.5,-3.5); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(-1,0); ctx.lineTo(3.5,3.5); ctx.stroke();
  ctx.strokeStyle='rgba(255,224,102,.35)';
  ctx.beginPath(); ctx.moveTo(-8,0); ctx.lineTo(6,0); ctx.stroke();
  ctx.fillStyle='rgba(255,224,102,.35)';
  ctx.beginPath(); ctx.moveTo(-10,0); ctx.lineTo(-6,-2); ctx.lineTo(-6,2); ctx.closePath(); ctx.fill();
  ctx.restore();
}

function drawCounterIons() {
  counterIons.forEach(ci => {
    ctx.save();
    const g=ctx.createRadialGradient(ci.x,ci.y,0,ci.x,ci.y,ci.r*2.5);
    g.addColorStop(0,'rgba(255,51,102,.4)'); g.addColorStop(1,'rgba(255,51,102,0)');
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(ci.x,ci.y,ci.r*2.5,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#ff3366'; ctx.shadowColor='#ff3366'; ctx.shadowBlur=7;
    ctx.beginPath(); ctx.arc(ci.x,ci.y,ci.r,0,Math.PI*2); ctx.fill();
    ctx.shadowBlur=0; ctx.fillStyle='#fff';
    ctx.font='bold 9px JetBrains Mono,monospace'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText('−',ci.x,ci.y); ctx.restore();
  });
}

function drawCoIons() {
  coIons.forEach(ci => {
    ctx.save();
    const g=ctx.createRadialGradient(ci.x,ci.y,0,ci.x,ci.y,ci.r*2.5);
    g.addColorStop(0,'rgba(0,255,136,.3)'); g.addColorStop(1,'rgba(0,255,136,0)');
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(ci.x,ci.y,ci.r*2.5,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#00ff88'; ctx.shadowColor='#00ff88'; ctx.shadowBlur=5;
    ctx.beginPath(); ctx.arc(ci.x,ci.y,ci.r,0,Math.PI*2); ctx.fill();
    ctx.shadowBlur=0; ctx.fillStyle='#003';
    ctx.font='bold 9px JetBrains Mono,monospace'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText('+',ci.x,ci.y); ctx.restore();
  });
}

function drawIon() {
  const cx=ion.x, cy=ion.y, r=ion.r; ctx.save();
  const og=ctx.createRadialGradient(cx,cy,0,cx,cy,r*3.5);
  og.addColorStop(0,'rgba(0,212,255,.3)'); og.addColorStop(1,'rgba(0,212,255,0)');
  ctx.fillStyle=og; ctx.beginPath(); ctx.arc(cx,cy,r*3.5,0,Math.PI*2); ctx.fill();
  const bg=ctx.createRadialGradient(cx-r*.3,cy-r*.3,r*.1,cx,cy,r);
  bg.addColorStop(0,'#80f0ff'); bg.addColorStop(.5,'#00b4d8'); bg.addColorStop(1,'#0077a8');
  ctx.fillStyle=bg; ctx.shadowColor='#00d4ff'; ctx.shadowBlur=18;
  ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='rgba(255,255,255,.3)'; ctx.shadowBlur=0;
  ctx.beginPath(); ctx.arc(cx-r*.3,cy-r*.3,r*.32,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#fff'; ctx.font='bold 11px Sora,sans-serif';
  ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('Na⁺',cx,cy);
  ctx.restore();
}

function drawEfield() {
  if(efield<5) return;
  const s=efield/100, rows=4, sp=canvas.height/(rows+1);
  ctx.save(); ctx.globalAlpha=s*.35; ctx.strokeStyle='#ffe066'; ctx.lineWidth=1;
  for(let i=1;i<=rows;i++){
    const y=i*sp; ctx.beginPath();
    for(let x=0;x<canvas.width;x+=70){
      ctx.moveTo(x,y); ctx.lineTo(x+50,y);
      ctx.moveTo(x+50,y); ctx.lineTo(x+43,y-4);
      ctx.moveTo(x+50,y); ctx.lineTo(x+43,y+4);
    }
    ctx.stroke();
  }
  ctx.globalAlpha=s*.7; ctx.fillStyle='#ffe066';
  ctx.font='10px JetBrains Mono,monospace'; ctx.textAlign='left';
  ctx.fillText('E →',8,16); ctx.restore();
}

function drawBackflow() {
  const s=efield/100;
  backflowPtcl.forEach(p => {
    ctx.save(); ctx.globalAlpha=p.alpha*s;
    const g=ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,7);
    g.addColorStop(0,'rgba(255,140,0,.9)'); g.addColorStop(1,'rgba(255,140,0,0)');
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(p.x,p.y,7,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='rgba(255,140,0,.4)'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(p.x+10,p.y); ctx.lineTo(p.x-4,p.y); ctx.stroke();
    ctx.restore();
  });
}

function drawLabels() {
  ctx.save(); ctx.font='10px JetBrains Mono,monospace';
  if(currentStep===0 && showDipoles) {
    const L=(t,x,y,c)=>{
      ctx.fillStyle='rgba(7,11,20,.82)';
      const m=ctx.measureText(t); ctx.fillRect(x-2,y-11,m.width+4,15);
      ctx.fillStyle=c; ctx.fillText(t,x,y);
    };
    L('Primary',   ion.x+ion.r+20, ion.y-ion.r-12, '#b4a0ff');
    L('Secondary', ion.x+ion.r+55, ion.y-ion.r-2,  'rgba(180,160,255,.55)');
  }
  if(currentStep>=2 && atmLag>0.08 && !infDil) {
    const dr=debyeR(); ctx.save();
    ctx.strokeStyle='#ffe066'; ctx.fillStyle='#ffe066'; ctx.lineWidth=1.5;
    ctx.beginPath(); ctx.moveTo(ion.x+ion.r+5,ion.y); ctx.lineTo(ion.x+ion.r+24,ion.y); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(ion.x+ion.r+26,ion.y); ctx.lineTo(ion.x+ion.r+18,ion.y-4); ctx.lineTo(ion.x+ion.r+18,ion.y+4); ctx.closePath(); ctx.fill();
    ctx.fillStyle='rgba(255,51,102,.8)'; ctx.fillText('lagging ellipse',ion.x-42,ion.y+dr+16);
    ctx.restore();
  }
  if(currentStep>=3 && efield>20 && !infDil) {
    ctx.fillStyle='rgba(255,140,0,.82)';
    ctx.fillText('← backflow',ion.x-54,ion.y+debyeR()+16);
  }
  ctx.restore();
}

/* ════════════════════════════════════════════════════
   CONDUCTIVITY CHART
════════════════════════════════════════════════════ */
function drawChart() {
  const cv=chartCv, c=chartCtx, w=cv.width, h=cv.height;
  if(!w||!h) return;
  c.clearRect(0,0,w,h);
  c.fillStyle='rgba(0,0,0,.2)'; c.fillRect(0,0,w,h);
  const px=26,py=8,pw=w-34,ph=h-20;
  c.strokeStyle='rgba(107,122,153,.45)'; c.lineWidth=1;
  c.beginPath(); c.moveTo(px,py); c.lineTo(px,py+ph); c.lineTo(px+pw,py+ph); c.stroke();
  c.fillStyle='rgba(107,122,153,.7)'; c.font='8px JetBrains Mono,monospace';
  c.textAlign='center'; c.fillText('√c',px+pw/2,h-2);
  c.save(); c.translate(8,py+ph/2); c.rotate(-Math.PI/2); c.fillText('Λ',0,0); c.restore();
  const L0=1,A=.22,B=.30;
  c.beginPath(); c.strokeStyle='#00d4ff'; c.lineWidth=2;
  for(let i=0;i<=100;i++){
    const sc=i/100*.8, La=Math.max(.1,L0-(A+B*L0)*sc);
    i===0?c.moveTo(px+(sc/.8)*pw,py+ph-La*ph):c.lineTo(px+(sc/.8)*pw,py+ph-La*ph);
  }
  c.stroke();
  const sc2=Math.sqrt(concentration)*.4;
  const La2=infDil?L0:Math.max(.1,L0-(A+B*L0)*sc2);
  c.beginPath(); c.fillStyle='#ffe066'; c.shadowColor='#ffe066'; c.shadowBlur=7;
  c.arc(px+Math.min(pw,(sc2/.8)*pw),py+ph-La2*ph,4,0,Math.PI*2); c.fill();
  c.shadowBlur=0; c.beginPath(); c.fillStyle='#00ff88';
  c.arc(px,py+ph-L0*ph,4,0,Math.PI*2); c.fill();
}

/* ════════════════════════════════════════════════════
   CONTROLS
════════════════════════════════════════════════════ */
// Unified setter functions that sync all instances
function setEfield(v) {
  efield = v;
  const label = (v/10).toFixed(1);
  ['efieldVal','mEfieldVal'].forEach(id=>{const e=document.getElementById(id);if(e)e.textContent=label;});
  ['sliderEfield','mSliderEfield'].forEach(id=>{const e=document.getElementById(id);if(e)e.value=v;});
  document.getElementById('badgeField').style.display = v>0?'block':'none';
}
function setSlow(v) {
  slowFactor=v;
  const label=(1/v).toFixed(1)+'×';
  ['slowVal','mSlowVal'].forEach(id=>{const e=document.getElementById(id);if(e)e.textContent=label;});
  ['sliderSlow','mSliderSlow'].forEach(id=>{const e=document.getElementById(id);if(e)e.value=v;});
}
function setConc(v) {
  concentration=v/100;
  const label=concentration.toFixed(2)+' M';
  ['concVal','mConcVal'].forEach(id=>{const e=document.getElementById(id);if(e)e.textContent=label;});
  ['sliderConc','mSliderConc'].forEach(id=>{const e=document.getElementById(id);if(e)e.value=v;});
  initParticles();
}

// Wire all sliders (desktop + mobile)
document.getElementById('sliderEfield').addEventListener('input', function(){setEfield(+this.value);});
document.getElementById('sliderSlow').addEventListener('input',   function(){setSlow(+this.value);});
document.getElementById('sliderConc').addEventListener('input',   function(){setConc(+this.value);});
document.getElementById('mSliderEfield').addEventListener('input',function(){setEfield(+this.value);});
document.getElementById('mSliderSlow').addEventListener('input',  function(){setSlow(+this.value);});
document.getElementById('mSliderConc').addEventListener('input',  function(){setConc(+this.value);});

function toggleInfDil() {
  infDil=!infDil;
  ['toggleInfDil','mToggleInfDil'].forEach(id=>{const e=document.getElementById(id);if(e)e.classList.toggle('active',infDil);});
  document.getElementById('badgeInfDil').style.display=infDil?'block':'none';
  initParticles();
}
function toggleLabels() {
  showLabels=!showLabels;
  document.getElementById('toggleLabels').classList.toggle('active',showLabels);
}
function toggleDipoles() {
  showDipoles=!showDipoles;
  ['toggleDipoles','mToggleDipoles'].forEach(id=>{const e=document.getElementById(id);if(e)e.classList.toggle('active',showDipoles);});
}

function doPause() {
  paused=!paused;
  document.getElementById('btnPause').innerHTML = paused
    ? '▶ <span class="btn-label">Resume</span>'
    : '⏸ <span class="btn-label">Pause</span>';
}
function doReset() {
  ion.x=canvas.width/2; ion.y=canvas.height/2;
  ion.vx=0; ion.vy=0; atmLag=0; animTime=0;
  initParticles();
}

document.getElementById('btnPause').addEventListener('click', doPause);
document.getElementById('btnReset').addEventListener('click', doReset);
document.getElementById('btnNext').addEventListener('click',  ()=>setStep(Math.min(3,currentStep+1)));

/* ════════════════════════════════════════════════════
   DRAG — mouse
════════════════════════════════════════════════════ */
canvas.addEventListener('mousedown', e=>{
  const r=canvas.getBoundingClientRect(), mx=e.clientX-r.left, my=e.clientY-r.top;
  const dx=mx-ion.x, dy=my-ion.y;
  if(dx*dx+dy*dy<(ion.r+14)*(ion.r+14)) ion.dragging=true;
});
canvas.addEventListener('mousemove', e=>{
  if(!ion.dragging)return;
  const r=canvas.getBoundingClientRect();
  ion.x=e.clientX-r.left; ion.y=e.clientY-r.top;
});
canvas.addEventListener('mouseup',    ()=>{ion.dragging=false;ion.vx=0;ion.vy=0;});
canvas.addEventListener('mouseleave', ()=>{ion.dragging=false;ion.vx=0;ion.vy=0;});

/* ════════════════════════════════════════════════════
   DRAG — touch
════════════════════════════════════════════════════ */
canvas.addEventListener('touchstart', e=>{
  const t=e.touches[0], r=canvas.getBoundingClientRect();
  const mx=t.clientX-r.left, my=t.clientY-r.top;
  const dx=mx-ion.x, dy=my-ion.y;
  if(dx*dx+dy*dy<(ion.r+28)*(ion.r+28)){
    ion.dragging=true;
    e.preventDefault();
  }
},{passive:false});
canvas.addEventListener('touchmove', e=>{
  if(!ion.dragging)return;
  e.preventDefault();
  const t=e.touches[0], r=canvas.getBoundingClientRect();
  ion.x=t.clientX-r.left; ion.y=t.clientY-r.top;
},{passive:false});
canvas.addEventListener('touchend', ()=>{ion.dragging=false;ion.vx=0;ion.vy=0;});

/* ════════════════════════════════════════════════════
   RESIZE OBSERVER (canvas reacts to fluid container)
════════════════════════════════════════════════════ */
const ro = new ResizeObserver(()=>{ resizeCanvas(); });
ro.observe(canvas.parentElement);
// Also observe chart container
const chartRo = new ResizeObserver(()=>{
  const cc = chartCv.parentElement;
  if(cc) { chartCv.width = cc.clientWidth-20; }
});
chartRo.observe(chartCv.parentElement);

/* ════════════════════════════════════════════════════
   MAIN LOOP
════════════════════════════════════════════════════ */
function loop(ts) {
  const dt = Math.min((ts-lastTime)/1000, .05);
  lastTime = ts;
  frameCount++;
  if(ts-lastFpsTime>600){
    fps=Math.round(frameCount*1000/(ts-lastFpsTime));
    frameCount=0; lastFpsTime=ts;
    document.getElementById('fpsStat').textContent=fps;
  }
  update(dt);
  draw();
  drawChart();
  requestAnimationFrame(loop);
}

/* ════════════════════════════════════════════════════
   INIT
════════════════════════════════════════════════════ */
resizeCanvas();
setStep(0);
requestAnimationFrame(loop);
</script>
</body>
</html>
